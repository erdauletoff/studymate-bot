# Разбор проекта StudyMate

Дата: 2026-02-01

Ниже — статический обзор кода (без запуска), с фокусом на риски, производительность и поддерживаемость.

## Критично
1) Кодировки текстов (моджибейк)
- Проблема: часть файлов, судя по содержимому, сохранена в CP1251/ANSI и читается как UTF-8.
- Последствия: поломанные тексты, кнопки, сопоставления по строкам и regex (например, поиск строки "Тема").
- Где:
  - bot/texts.py
  - bot/handlers/start.py
  - bot/handlers/quiz.py
  - bot/middleware.py
  - bot/utils/quiz_parser.py
  - backend/students/season_models.py
- Рекомендация: привести все исходники к UTF-8, настроить редактор/линтер, чтобы предотвращать повтор.

2) Небезопасные prod-настройки Django
- Проблема: DEBUG по умолчанию может быть false, но SECRET_KEY имеет дефолт, ALLOWED_HOSTS=['*'].
- Где: backend/core/settings.py
- Рекомендация: убрать дефолт SECRET_KEY, требовать переменные окружения; ограничить ALLOWED_HOSTS.

3) Несогласованные дефолты языка
- Проблема: DEFAULT_LANG = "qq" в texts.py и "ru" в db.py.
- Последствия: непредсказуемые переводы или фоллбэки.
- Где: bot/texts.py, bot/db.py
- Рекомендация: унифицировать значение и гарантировать наличие ключа в TEXTS.

## Высокий приоритет (производительность/устойчивость)
1) N+1 и O(N^2) в статистике/рейтингах
- Проблема: циклы с запросами внутри и вычисления в Python для больших выборок.
- Где: bot/db.py
  - get_quiz_average_score
  - get_quiz_stats
  - get_quiz_stats_by_ids
  - get_quiz_top_students
  - get_global_leaderboard
  - get_student_rank
- Рекомендация: переписать через агрегаты/подзапросы или window-функции; уменьшить число запросов.

2) Агрегация статистики в Python
- Проблема: sum() по QuerySet без агрегации в БД.
- Где: backend/students/models.py (get_quiz_stats)
- Рекомендация: заменить на DB-агрегаты (Avg, Sum, Count).

3) Отсутствуют индексы на часто используемые поля
- Где: backend/quizzes/models.py, backend/downloads/models.py, backend/questions/models.py,
  backend/materials/models.py, backend/students/models.py
- Рекомендация: добавить индексы на поля фильтрации (student, quiz, finished_at, quiz_type,
  available_until, mentor, telegram_id, created_at).

4) Работа со временем и тайм-зоной
- Проблема: date.today() без TZ.
- Где: bot/db.py (streak)
- Рекомендация: использовать timezone.localdate()/timezone.now().

## Средний приоритет (надёжность/поддерживаемость)
1) Инициализация Django при импорте
- Проблема: django.setup() вызывается в bot/db.py на импорт.
- Где: bot/db.py, run_bot.py
- Рекомендация: централизовать инициализацию, не делать side effects в модуле.

2) Сопоставление кнопок по “сырым” строкам
- Проблема: сравнение текстов кнопок напрямую ломается при переводах и кодировках.
- Где: bot/middleware.py
- Рекомендация: сравнивать по callback_data или по t("btn_*", lang).

3) Проверка членства в группах в цикле
- Проблема: последовательные API-вызовы по всем менторам.
- Где: bot/handlers/start.py
- Рекомендация: параллелить (asyncio.gather) или кэшировать user->mentor.

4) FSM storage в памяти
- Проблема: состояния теряются при рестарте.
- Где: run_bot.py
- Рекомендация: перейти на RedisStorage (или иной persistent storage).

## Низкий приоритет (качество/удобство)
1) Большой монолитный файл переводов
- Где: bot/texts.py
- Рекомендация: вынести в JSON/YAML + валидация ключей.

2) Логирование и наблюдаемость
- Проблема: нет структурированных логов ошибок Telegram API/БД.
- Рекомендация: добавить логирование ключевых ошибок и метрик.

## Предложенный порядок улучшений
1) Починить кодировки и дефолт языка.
2) Привести prod-настройки в безопасное состояние.
3) Оптимизировать статистику/рейтинги и добавить индексы.
4) Перевести FSM storage в persistent.

Если нужно, могу подготовить конкретные правки/миграции/SQL-оптимизации.
